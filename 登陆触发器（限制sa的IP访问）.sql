USE [master]
GO

/****** Object:  DdlTrigger [tr_sa_connection_limit]    Script Date: 2018/11/20 10:33:33 ******/
DROP TRIGGER [tr_sa_connection_limit] ON ALL SERVER
GO

/****** Object:  DdlTrigger [tr_sa_connection_limit]    Script Date: 2018/11/20 10:33:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TRIGGER [tr_sa_connection_limit]
ON ALL SERVER WITH EXECUTE AS 'sa'
FOR LOGON
AS
BEGIN
--限制test这个帐号的连接
IF ORIGINAL_LOGIN()= 'sa'
--允许sa在本机和下面的IP登录
AND
(SELECT EVENTDATA().value('(/EVENT_INSTANCE/ClientHost)[1]', 'NVARCHAR(15)'))
NOT IN('<local machine>'
,'172.16.1.30',
'192.168.4.2',
'192.168.4.3',
'192.168.10.3',
'192.168.4.8',
'192.168.4.7',
'192.168.4.6',
'192.168.4.29',
'192.168.4.32',
'192.168.4.33',
'192.168.4.33',
'192.168.4.34',
'192.168.4.62',
'192.168.4.14',
'192.168.4.107',
'192.168.0.150',
'192.168.0.132',
'192.168.4.24',
'192.168.4.80',
'192.168.4.25',
'192.168.4.137',
'192.168.4.127',
'192.168.4.107',
'192.168.4.1',
'192.168.4.125',
'192.168.4.126',
'192.168.4.101',
'192.168.4.102',
'192.168.4.105',
'192.168.4.53',
'192.168.4.54',
'192.168.4.55',
'192.168.4.100',
'192.168.4.108',
'192.168.4.109',
'192.168.4.64',
'192.168.4.133',
'192.168.4.135',
'192.168.4.134',
'192.168.4.98',
'192.168.4.152',
'192.168.4.153',
'192.168.4.122',
'192.168.4.132',
'192.168.4.131',
'192.168.4.121',
'192.168.4.151',
'192.168.4.128',
'192.168.4.129',
'192.168.4.130',
'192.168.4.106',
'192.168.4.113',
'192.168.4.114',
'192.168.4.52',
'192.168.4.112',
'192.168.4.201',
'192.168.4.202',
'172.16.252.1',
'172.16.252.2',
'172.16.252.3',
'172.16.252.4',
'192.168.4.40',
'192.168.4.71',
'192.168.4.83',
'192.168.4.30',
'192.168.4.20',
'192.168.10.9',
'192.168.4.60',
'192.168.4.51',
'192.168.4.50',
'192.168.0.111',
'192.169.1.200',
'192.170.2.2',
'192.170.2.3'
)
ROLLBACK;
END;
GO

ENABLE TRIGGER [tr_sa_connection_limit] ON ALL SERVER
GO


